<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø²Ù†Ø¯Ù‡ | Live-Umfrage</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script data-goatcounter="https://aguitoo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --secondary: #f472b6;
            --accent: #fbbf24;
            --success: #10b981;
            --error: #ef4444;
            --bg: #0f172a;
            --card: #1e293b;
            --card-light: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            direction: rtl;
            color: var(--text);
        }

        .container { max-width: 800px; margin: 0 auto; padding: 20px; }

        .screen { display: none; animation: fadeIn 0.5s ease; }
        .screen.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 24px;
            padding: 40px 30px;
            text-align: center;
            margin-top: 30px;
        }

        .welcome-icon { font-size: 4rem; margin-bottom: 20px; }
        .welcome-title { font-size: 2rem; font-weight: 700; margin-bottom: 10px; }
        .welcome-subtitle { font-size: 1.1rem; opacity: 0.9; margin-bottom: 30px; }

        .role-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 300px;
            margin: 0 auto;
        }

        .role-btn {
            padding: 18px 30px;
            border: none;
            border-radius: 16px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .role-btn.host { background: white; color: var(--primary); }
        .role-btn.player {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }
        .role-btn:hover { transform: scale(1.03); }

        .join-card, .lobby-card, .waiting-card, .question-card-wrapper, .results-card {
            background: var(--card);
            border-radius: 24px;
            padding: 35px;
            text-align: center;
            margin-top: 30px;
        }

        .join-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 25px; color: var(--accent); }

        .code-input-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            direction: ltr;
        }

        .code-input {
            width: 60px;
            height: 70px;
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            border: 3px solid var(--card-light);
            border-radius: 12px;
            background: var(--bg);
            color: var(--text);
            font-family: 'Vazirmatn', sans-serif;
            text-transform: uppercase;
        }
        .code-input:focus { outline: none; border-color: var(--primary); }

        .name-input {
            width: 100%;
            max-width: 300px;
            padding: 15px 20px;
            border: 2px solid var(--card-light);
            border-radius: 12px;
            background: var(--bg);
            color: var(--text);
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 20px;
        }
        .name-input:focus { outline: none; border-color: var(--primary); }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn:hover { transform: scale(1.05); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .back-link {
            color: var(--text-muted);
            margin-top: 20px;
            cursor: pointer;
            font-size: 0.95rem;
            display: inline-block;
        }
        .back-link:hover { color: var(--text); }

        .error-msg { color: var(--error); margin-top: 15px; font-size: 0.95rem; }

        .game-code-display {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
        }
        .game-code-label { font-size: 1rem; opacity: 0.9; margin-bottom: 10px; }
        .game-code { font-size: 3.5rem; font-weight: 700; letter-spacing: 12px; direction: ltr; }

        .players-section { margin: 25px 0; }
        .players-title { font-size: 1.1rem; color: var(--accent); margin-bottom: 15px; }
        .players-count { font-size: 2.5rem; font-weight: 700; color: var(--success); }

        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .player-chip {
            background: var(--card-light);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .start-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 30px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        .start-btn:hover { transform: scale(1.05); }
        .start-btn:disabled { background: var(--card-light); cursor: not-allowed; transform: none; }

        .waiting-icon { font-size: 4rem; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .waiting-text { font-size: 1.3rem; color: var(--text-muted); }
        .player-name-display { font-size: 1.5rem; font-weight: 600; color: var(--accent); margin-top: 15px; }

        .question-header {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .question-progress { font-size: 1rem; color: var(--text-muted); }

        .question-card {
            background: var(--card);
            border-radius: 24px;
            padding: 30px;
            margin-bottom: 20px;
        }

        .question-text {
            font-size: 1.4rem;
            font-weight: 600;
            line-height: 1.9;
            margin-bottom: 25px;
            text-align: center;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .option-btn {
            background: var(--card-light);
            border: 3px solid transparent;
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .option-btn:hover:not(.disabled) { border-color: var(--primary); transform: scale(1.02); }
        .option-btn.selected { border-color: var(--primary); background: rgba(99, 102, 241, 0.2); }
        .option-btn.disabled { cursor: default; opacity: 0.7; }
        .option-icon { font-size: 2rem; margin-bottom: 10px; }
        .option-text { font-size: 1rem; line-height: 1.6; }

        .stats-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15, 23, 42, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .stats-overlay.show { display: flex; }

        .stats-card {
            background: var(--card);
            border-radius: 24px;
            padding: 35px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }
        .stats-title { font-size: 1.3rem; color: var(--accent); margin-bottom: 25px; }

        .stat-bar-item { margin-bottom: 15px; text-align: right; }
        .stat-bar-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; }
        .stat-bar-container { background: var(--card-light); border-radius: 10px; height: 35px; overflow: hidden; }
        .stat-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 40px;
        }
        .stat-bar.color-0 { background: linear-gradient(90deg, #ef4444, #f87171); }
        .stat-bar.color-1 { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .stat-bar.color-2 { background: linear-gradient(90deg, #10b981, #34d399); }
        .stat-bar.color-3 { background: linear-gradient(90deg, #f59e0b, #fbbf24); }

        .host-controls {
            background: var(--card);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .host-badge { background: var(--accent); color: var(--bg); padding: 5px 15px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; }
        .responses-count { color: var(--success); font-weight: 600; }
        .show-stats-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .results-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .results-subtitle { color: var(--text-muted); margin-bottom: 30px; }

        .personality-results { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; }
        .personality-card { background: var(--card-light); border-radius: 16px; padding: 20px; }
        .personality-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .personality-name { font-weight: 600; margin-bottom: 5px; }
        .personality-count { color: var(--accent); font-size: 1.5rem; font-weight: 700; }

        .vocab-recap { background: var(--card-light); border-radius: 16px; padding: 20px; margin-top: 25px; text-align: right; }
        .vocab-recap-title { color: var(--accent); font-weight: 600; margin-bottom: 15px; text-align: center; }
        .vocab-recap-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .vocab-recap-item { background: var(--bg); padding: 10px; border-radius: 8px; font-size: 0.9rem; }

        .restart-btn {
            background: var(--card-light);
            color: var(--text);
            border: none;
            padding: 15px 35px;
            border-radius: 30px;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 25px;
        }
        .restart-btn:hover { background: var(--primary); }

        .loading-msg { color: var(--accent); font-size: 1rem; margin-top: 20px; }

        @media (max-width: 600px) {
            .options-grid { grid-template-columns: 1fr; }
            .game-code { font-size: 2.5rem; letter-spacing: 8px; }
            .code-input { width: 50px; height: 60px; font-size: 1.5rem; }
            .personality-results, .vocab-recap-list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Screen -->
        <div id="welcomeScreen" class="screen active">
            <div class="welcome-card">
                <div class="welcome-icon">ğŸ“Š</div>
                <h1 class="welcome-title">Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø²Ù†Ø¯Ù‡</h1>
                <p class="welcome-subtitle">Live-Meinungsumfrage | Ø´Ø®ØµÛŒØª Ø´ØºÙ„ÛŒ</p>
                
                <div class="role-buttons">
                    <button class="role-btn host" id="hostBtn">
                        ğŸ‘¨â€ğŸ« Ù…ÛŒØ²Ø¨Ø§Ù† | Moderator
                    </button>
                    <button class="role-btn player" id="playerBtn">
                        ğŸ® Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ | Teilnehmer
                    </button>
                </div>
                <p class="loading-msg" id="loadingMsg">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
            </div>
        </div>

        <!-- Join Screen -->
        <div id="joinScreen" class="screen">
            <div class="join-card">
                <h2 class="join-title">ğŸ® ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ | Beitreten</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Ú©Ø¯ Ø¨Ø§Ø²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
                
                <div class="code-input-container">
                    <input type="text" class="code-input" maxlength="1" id="code1">
                    <input type="text" class="code-input" maxlength="1" id="code2">
                    <input type="text" class="code-input" maxlength="1" id="code3">
                    <input type="text" class="code-input" maxlength="1" id="code4">
                </div>
                
                <input type="text" class="name-input" id="playerName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§ / Ihr Name">
                
                <button class="btn" id="joinBtn">ÙˆØ±ÙˆØ¯ | Beitreten</button>
                
                <div class="error-msg" id="joinError"></div>
                <p class="back-link" id="backToWelcome">â† Ø¨Ø§Ø²Ú¯Ø´Øª</p>
            </div>
        </div>

        <!-- Host Lobby -->
        <div id="hostLobby" class="screen">
            <div class="lobby-card">
                <div class="game-code-display">
                    <p class="game-code-label">Ú©Ø¯ Ø¨Ø§Ø²ÛŒ | Spielcode</p>
                    <p class="game-code" id="gameCodeDisplay">----</p>
                </div>
                
                <div class="players-section">
                    <p class="players-title">ğŸ‘¥ Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù† | Teilnehmer</p>
                    <p class="players-count" id="playersCount">0</p>
                    <div class="players-list" id="playersList"></div>
                </div>
                
                <button class="start-btn" id="startGameBtn" disabled>
                    ğŸš€ Ø´Ø±ÙˆØ¹ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ
                </button>
            </div>
        </div>

        <!-- Player Waiting -->
        <div id="playerWaiting" class="screen">
            <div class="waiting-card">
                <div class="waiting-icon">â³</div>
                <p class="waiting-text">Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ...</p>
                <p class="waiting-text" style="font-size: 1rem;">Warten auf Spielstart...</p>
                <p class="player-name-display" id="playerNameDisplay"></p>
            </div>
        </div>

        <!-- Question Screen -->
        <div id="questionScreen" class="screen">
            <div class="host-controls" id="hostControls" style="display: none;">
                <span class="host-badge">ğŸ‘¨â€ğŸ« Ù…ÛŒØ²Ø¨Ø§Ù†</span>
                <span class="responses-count" id="responsesCount">Û° Ù¾Ø§Ø³Ø®</span>
                <button class="show-stats-btn" id="showStatsBtn">ğŸ“Š Ù†ØªØ§ÛŒØ¬</button>
            </div>
            
            <div class="question-header">
                <span class="question-progress" id="questionProgress">Ø³Ø¤Ø§Ù„ Û± Ø§Ø² Û²Û°</span>
            </div>
            
            <div class="question-card">
                <p class="question-text" id="questionText">Ø³Ø¤Ø§Ù„</p>
                <div class="options-grid" id="optionsGrid"></div>
            </div>
        </div>

        <!-- Stats Overlay -->
        <div class="stats-overlay" id="statsOverlay">
            <div class="stats-card">
                <h3 class="stats-title">ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ† Ø³Ø¤Ø§Ù„</h3>
                <div class="stats-bars" id="statsBars"></div>
                <button class="btn" id="statsNextBtn">Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ÛŒ â†</button>
            </div>
        </div>

        <!-- Final Results -->
        <div id="resultsScreen" class="screen">
            <div class="results-card">
                <h2 class="results-title">ğŸ‰ Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ</h2>
                <p class="results-subtitle">Endergebnisse der Umfrage</p>
                <div class="personality-results" id="personalityResults"></div>
                <div class="vocab-recap">
                    <p class="vocab-recap-title">ğŸ“š ÙˆØ§Ú˜Ú¯Ø§Ù† ÛŒØ§Ø¯ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡</p>
                    <div class="vocab-recap-list" id="vocabRecap"></div>
                </div>
                <button class="restart-btn" id="restartBtn">ğŸ”„ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        // Survey Questions
        const questions = [
            { question: "ØµØ¨Ø­â€ŒÙ‡Ø§ Ú†Ú¯ÙˆÙ†Ù‡ Ø¨Ù‡ Ø³Ø± Ú©Ø§Ø± Ù…ÛŒâ€ŒØ±ÙˆÛŒØ¯ØŸ", options: [
                { icon: "â˜€ï¸", text: "Ø¨Ø§ Ø§Ù†Ø±Ú˜ÛŒ Ùˆ Ø®ÙˆØ´Ø­Ø§Ù„!", type: "E" },
                { icon: "ğŸ˜´", text: "Ø¨Ù‡ Ø³Ø®ØªÛŒ Ø¨ÛŒØ¯Ø§Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ…", type: "I" },
                { icon: "ğŸ§", text: "Ø¨Ø§ Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ùˆ Ù‚Ù‡ÙˆÙ‡", type: "C" },
                { icon: "ğŸƒ", text: "Ø¹Ø¬Ù„Ù‡â€ŒØ§ÛŒ! Ø¯ÛŒØ± Ù…ÛŒâ€ŒØ±Ø³Ù…", type: "S" }
            ], vocab: { fa: "ØµØ¨Ø­", de: "Morgen" }},
            { question: "Ø¯Ø± Ø¬Ù„Ø³Ø§Øª Ú©Ø§Ø±ÛŒ Ú†Ù‡ Ù†Ù‚Ø´ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ", options: [
                { icon: "ğŸ¤", text: "Ø±Ù‡Ø¨Ø± Ø¨Ø­Ø« Ù‡Ø³ØªÙ…", type: "L" },
                { icon: "ğŸ‘‚", text: "Ø¨ÛŒØ´ØªØ± Ú¯ÙˆØ´ Ù…ÛŒâ€ŒØ¯Ù‡Ù…", type: "I" },
                { icon: "ğŸ“", text: "ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ù…ÛŒâ€ŒÚ©Ù†Ù…", type: "A" },
                { icon: "ğŸ’¡", text: "Ø§ÛŒØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ù…ÛŒâ€ŒØ¯Ù‡Ù…", type: "C" }
            ], vocab: { fa: "Ø¬Ù„Ø³Ù‡", de: "Meeting" }},
            { question: "ÙˆÙ‚ØªÛŒ Ù‡Ù…Ú©Ø§Ø±ØªØ§Ù† Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯ØŸ", options: [
                { icon: "ğŸ¤", text: "ÙÙˆØ±Ø§Ù‹ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù…", type: "E" },
                { icon: "ğŸ¤”", text: "Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§Ù‡Ø¯ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù…", type: "I" },
                { icon: "ğŸ“", text: "Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒÚ¯ÙˆÛŒÙ…", type: "A" },
                { icon: "ğŸ’ª", text: "ÛŒØ§Ø¯Ø´ Ù…ÛŒâ€ŒØ¯Ù‡Ù… Ø®ÙˆØ¯Ø´ Ø­Ù„ Ú©Ù†Ø¯", type: "L" }
            ], vocab: { fa: "Ù‡Ù…Ú©Ø§Ø±", de: "Kollege" }},
            { question: "Ù…Ø­ÛŒØ· Ú©Ø§Ø± Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ Ø´Ù…Ø§ØŸ", options: [
                { icon: "ğŸ¢", text: "Ø¯ÙØªØ± Ø´Ù„ÙˆØº", type: "E" },
                { icon: "ğŸ ", text: "Ú©Ø§Ø± Ø§Ø² Ø®Ø§Ù†Ù‡", type: "I" },
                { icon: "â˜•", text: "Ú©Ø§ÙÙ‡ ÛŒØ§ ÙØ¶Ø§ÛŒ Ù…Ø´ØªØ±Ú©", type: "C" },
                { icon: "ğŸŒ³", text: "Ø¬Ø§ÛŒÛŒ Ø¨Ø§ Ø·Ø¨ÛŒØ¹Øª", type: "S" }
            ], vocab: { fa: "Ù…Ø­ÛŒØ· Ú©Ø§Ø±", de: "Arbeitsumfeld" }},
            { question: "Ú†Ú¯ÙˆÙ†Ù‡ ØªØµÙ…ÛŒÙ… Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒØ¯ØŸ", options: [
                { icon: "ğŸ§ ", text: "Ø¨Ø§ ØªØ­Ù„ÛŒÙ„ Ùˆ Ù…Ù†Ø·Ù‚", type: "A" },
                { icon: "â¤ï¸", text: "Ø¨Ø§ Ø§Ø­Ø³Ø§Ø³ Ùˆ Ø´Ù‡ÙˆØ¯", type: "C" },
                { icon: "ğŸ‘¥", text: "Ø¨Ø§ Ù…Ø´ÙˆØ±Øª Ø¯ÛŒÚ¯Ø±Ø§Ù†", type: "E" },
                { icon: "âš¡", text: "Ø³Ø±ÛŒØ¹!", type: "S" }
            ], vocab: { fa: "ØªØµÙ…ÛŒÙ…", de: "Entscheidung" }},
            { question: "Ù¾Ø§Ø¯Ø§Ø´ Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ØŸ", options: [
                { icon: "ğŸ’°", text: "Ù¾ÙˆÙ„ Ùˆ Ø­Ù‚ÙˆÙ‚ Ø¨Ø§Ù„Ø§", type: "A" },
                { icon: "ğŸ†", text: "ØªÙ‚Ø¯ÛŒØ± Ùˆ Ø§Ø­ØªØ±Ø§Ù…", type: "L" },
                { icon: "ğŸ‰", text: "Ù…Ø±Ø®ØµÛŒ Ø¨ÛŒØ´ØªØ±", type: "S" },
                { icon: "ğŸ“ˆ", text: "Ø§Ø±ØªÙ‚Ø§ÛŒ Ø´ØºÙ„ÛŒ", type: "L" }
            ], vocab: { fa: "Ù¾Ø§Ø¯Ø§Ø´", de: "Belohnung" }},
            { question: "ÙˆÙ‚ØªÛŒ Ú©Ø§Ø± Ø²ÛŒØ§Ø¯ Ø§Ø³ØªØŸ", options: [
                { icon: "ğŸ“‹", text: "Ù„ÛŒØ³Øª Ùˆ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒØ¨Ù†Ø¯ÛŒ", type: "A" },
                { icon: "ğŸ˜°", text: "Ø§Ø³ØªØ±Ø³ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù…", type: "S" },
                { icon: "â˜•", text: "Ø§ÙˆÙ„ Ø§Ø³ØªØ±Ø§Ø­Øª", type: "I" },
                { icon: "ğŸ¦¸", text: "Ù‡Ù…Ù‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ¯Ù‡Ù…!", type: "E" }
            ], vocab: { fa: "Ø§Ø³ØªØ±Ø³", de: "Stress" }},
            { question: "Ø±Ø§Ø¨Ø·Ù‡ Ø¨Ø§ Ø±Ø¦ÛŒØ³â€ŒØªØ§Ù†ØŸ", options: [
                { icon: "ğŸ˜Š", text: "Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ùˆ ØµÙ…ÛŒÙ…ÛŒ", type: "E" },
                { icon: "ğŸ“", text: "Ø±Ø³Ù…ÛŒ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ", type: "A" },
                { icon: "ğŸ˜¬", text: "Ú©Ù…ÛŒ ØªØ±Ø³Ù†Ø§Ú©!", type: "I" },
                { icon: "ğŸ¤·", text: "Ù…Ù† Ø®ÙˆØ¯Ù… Ø±Ø¦ÛŒØ³Ù…!", type: "L" }
            ], vocab: { fa: "Ø±Ø¦ÛŒØ³", de: "Chef" }},
            { question: "Ø²Ù…Ø§Ù† Ø§Ø³ØªØ±Ø§Ø­Øª Ù†Ø§Ù‡Ø§Ø±ØŸ", options: [
                { icon: "ğŸ‘¥", text: "Ø¨Ø§ Ù‡Ù…Ú©Ø§Ø±Ø§Ù† ØºØ°Ø§", type: "E" },
                { icon: "ğŸ“±", text: "ØªÙ†Ù‡Ø§ Ùˆ Ø¨Ø§ Ú¯ÙˆØ´ÛŒ", type: "I" },
                { icon: "ğŸš¶", text: "Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ", type: "S" },
                { icon: "ğŸ’»", text: "Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù…!", type: "A" }
            ], vocab: { fa: "Ø§Ø³ØªØ±Ø§Ø­Øª", de: "Pause" }},
            { question: "Ø§Ú¯Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ú©Ù†ÛŒØ¯ØŸ", options: [
                { icon: "ğŸ™‹", text: "Ø³Ø±ÛŒØ¹ Ø§Ø¹ØªØ±Ø§Ù Ù…ÛŒâ€ŒÚ©Ù†Ù…", type: "E" },
                { icon: "ğŸ”§", text: "Ø¢Ø±Ø§Ù… Ø­Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ù…", type: "I" },
                { icon: "ğŸ“Š", text: "ØªØ­Ù„ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ù… Ú†Ø±Ø§", type: "A" },
                { icon: "ğŸ˜…", text: "Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ú©Ø³ÛŒ Ù†ÙÙ‡Ù…Ø¯!", type: "S" }
            ], vocab: { fa: "Ø§Ø´ØªØ¨Ø§Ù‡", de: "Fehler" }},
            { question: "Ú†Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±ÛŒØ¯ØŸ", options: [
                { icon: "ğŸ¨", text: "Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡ Ùˆ Ù‡Ù†Ø±ÛŒ", type: "C" },
                { icon: "ğŸ“Š", text: "ØªØ­Ù„ÛŒÙ„ÛŒ Ø¨Ø§ Ø§Ø¹Ø¯Ø§Ø¯", type: "A" },
                { icon: "ğŸ‘¥", text: "Ú¯Ø±ÙˆÙ‡ÛŒ Ùˆ ØªÛŒÙ…ÛŒ", type: "E" },
                { icon: "ğŸƒ", text: "Ø³Ø±ÛŒØ¹ Ùˆ Ú©ÙˆØªØ§Ù‡", type: "S" }
            ], vocab: { fa: "Ù¾Ø±ÙˆÚ˜Ù‡", de: "Projekt" }},
            { question: "Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ØŸ", options: [
                { icon: "ğŸŒ…", text: "ØµØ¨Ø­ Ø²ÙˆØ¯ØŒ Ø²ÙˆØ¯ ØªÙ…Ø§Ù…", type: "A" },
                { icon: "ğŸŒ™", text: "Ø¯ÛŒØ± Ø´Ø±ÙˆØ¹ØŒ Ø¯ÛŒØ± ØªÙ…Ø§Ù…", type: "C" },
                { icon: "ğŸ•", text: "Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±", type: "I" },
                { icon: "â°", text: "Û¹ ØªØ§ Ûµ Ú©Ù„Ø§Ø³ÛŒÚ©", type: "S" }
            ], vocab: { fa: "Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ", de: "Arbeitszeit" }},
            { question: "ÙˆÙ‚ØªÛŒ Ø§ÛŒØ¯Ù‡â€ŒÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø±ÛŒØ¯ØŸ", options: [
                { icon: "ğŸ“¢", text: "Ø¨Ù‡ Ù‡Ù…Ù‡ Ù…ÛŒâ€ŒÚ¯ÙˆÛŒÙ…", type: "E" },
                { icon: "ğŸ“", text: "Ø§ÙˆÙ„ Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ù… Ùˆ ÙÚ©Ø±", type: "I" },
                { icon: "ğŸš€", text: "Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ø§Ø¬Ø±Ø§!", type: "L" },
                { icon: "ğŸ¤", text: "Ø¨Ø§ ÛŒÚ© Ù†ÙØ± Ù…Ø´ÙˆØ±Øª", type: "C" }
            ], vocab: { fa: "Ø§ÛŒØ¯Ù‡", de: "Idee" }},
            { question: "Ú†Ù‡ Ú†ÛŒØ² Ù†Ø§Ø±Ø§Ø­ØªØªØ§Ù† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ", options: [
                { icon: "ğŸŒ", text: "Ú©Ø§Ø± Ú©Ù†Ø¯ Ùˆ Ø¨ÛŒâ€ŒÙ‡Ø¯Ù", type: "L" },
                { icon: "ğŸ˜¤", text: "Ù‡Ù…Ú©Ø§Ø±Ø§Ù† Ø¨ÛŒâ€ŒØ§Ø­ØªØ±Ø§Ù…", type: "E" },
                { icon: "ğŸ“‹", text: "Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¨ÛŒâ€ŒÙ…Ù†Ø·Ù‚", type: "C" },
                { icon: "â°", text: "Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ Ø²ÛŒØ§Ø¯", type: "S" }
            ], vocab: { fa: "Ù†Ø§Ø±Ø§Ø­Øª", de: "verÃ¤rgert" }},
            { question: "Ù¾Ù†Ø¬ Ø³Ø§Ù„ Ø¢ÛŒÙ†Ø¯Ù‡ØŸ", options: [
                { icon: "ğŸ‘”", text: "Ù…Ø¯ÛŒØ± ØªÛŒÙ… Ø¨Ø²Ø±Ú¯", type: "L" },
                { icon: "ğŸŒ´", text: "Ø¨Ø§Ø²Ù†Ø´Ø³ØªÙ‡ Ø¯Ø± Ø³Ø§Ø­Ù„!", type: "S" },
                { icon: "ğŸ“", text: "ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ú†ÛŒØ² Ø¬Ø¯ÛŒØ¯", type: "C" },
                { icon: "ğŸ’¼", text: "Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ ÙˆÙ„ÛŒ Ø¨Ù‡ØªØ±", type: "A" }
            ], vocab: { fa: "Ø¢ÛŒÙ†Ø¯Ù‡", de: "Zukunft" }},
            { question: "Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø§Ù†ØªÙ‚Ø§Ø¯ØŸ", options: [
                { icon: "ğŸ™", text: "ØªØ´Ú©Ø± Ùˆ ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ", type: "A" },
                { icon: "ğŸ˜¢", text: "Ù†Ø§Ø±Ø§Ø­Øª Ù…ÛŒâ€ŒØ´ÙˆÙ…", type: "I" },
                { icon: "ğŸ¤¨", text: "Ø¨Ø³ØªÚ¯ÛŒ Ø¨Ù‡ Ú©ÛŒ Ú¯ÙØªÙ‡", type: "E" },
                { icon: "ğŸ’ª", text: "Ø§Ù†Ú¯ÛŒØ²Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ù…!", type: "L" }
            ], vocab: { fa: "Ø§Ù†ØªÙ‚Ø§Ø¯", de: "Kritik" }},
            { question: "ØºØ°Ø§ Ø¯Ø± Ù…Ø­Ù„ Ú©Ø§Ø±ØŸ", options: [
                { icon: "ğŸ¥—", text: "Ø³Ø§Ù„Ø§Ø¯ Ø³Ø§Ù„Ù…", type: "A" },
                { icon: "ğŸ•", text: "Ù¾ÛŒØªØ²Ø§ Ø¨Ø§ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†", type: "E" },
                { icon: "â˜•", text: "ÙÙ‚Ø· Ù‚Ù‡ÙˆÙ‡!", type: "C" },
                { icon: "ğŸ±", text: "ØºØ°Ø§ÛŒ Ø®Ø§Ù†Ú¯ÛŒ", type: "I" }
            ], vocab: { fa: "ØºØ°Ø§", de: "Essen" }},
            { question: "Ø§Ú¯Ø± Ù„Ø§ØªØ§Ø±ÛŒ Ø¨Ø¨Ø±ÛŒØ¯ØŸ", options: [
                { icon: "ğŸƒ", text: "ÙÙˆØ±Ø§Ù‹ Ø§Ø³ØªØ¹ÙØ§!", type: "S" },
                { icon: "ğŸ’¼", text: "Ù‡Ù…Ø§Ù† Ú©Ø§Ø± Ø§Ø¯Ø§Ù…Ù‡", type: "A" },
                { icon: "ğŸ¢", text: "Ø´Ø±Ú©Øª Ø®ÙˆØ¯Ù…", type: "L" },
                { icon: "ğŸŒ", text: "Ø³ÙØ± Ùˆ Ø¨Ø¹Ø¯ ÙÚ©Ø±", type: "C" }
            ], vocab: { fa: "Ù„Ø§ØªØ§Ø±ÛŒ", de: "Lotterie" }},
            { question: "Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ú©Ø§Ø±ØŸ", options: [
                { icon: "ğŸµ", text: "Ù¾Ø§Ù¾ Ùˆ Ø´Ø§Ø¯", type: "E" },
                { icon: "ğŸ»", text: "Ú©Ù„Ø§Ø³ÛŒÚ© Ùˆ Ø¢Ø±Ø§Ù…", type: "I" },
                { icon: "ğŸ”‡", text: "Ø³Ú©ÙˆØª! ØªÙ…Ø±Ú©Ø²", type: "A" },
                { icon: "ğŸ¸", text: "Ù‡Ø± Ú†ÛŒ Ø§Ù†Ø±Ú˜ÛŒ Ø¨Ø¯Ù‡", type: "C" }
            ], vocab: { fa: "Ù…ÙˆØ³ÛŒÙ‚ÛŒ", de: "Musik" }},
            { question: "Ø¬Ù…Ù„Ù‡â€ŒÛŒ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ØŸ", options: [
                { icon: "ğŸŒŸ", text: "ØªÙ„Ø§Ø´ Ú©Ù† Ù…ÙˆÙÙ‚ Ø´ÙˆÛŒ!", type: "L" },
                { icon: "ğŸ˜Œ", text: "Ø¢Ø±Ø§Ù…Ø´ Ù…Ù‡Ù…â€ŒØªØ± Ø§Ø² Ù¾ÙˆÙ„", type: "S" },
                { icon: "ğŸ¤", text: "Ø¨Ø§ Ù‡Ù… Ù‚ÙˆÛŒâ€ŒØªØ±ÛŒÙ…", type: "E" },
                { icon: "ğŸ§ ", text: "Ø¯Ø§Ù†Ø´ Ù‚Ø¯Ø±Øª Ø§Ø³Øª", type: "A" }
            ], vocab: { fa: "Ù…ÙˆÙÙ‚", de: "erfolgreich" }}
        ];

        const personalities = {
            L: { icon: "ğŸ¦", name: "Ø±Ù‡Ø¨Ø±", de: "AnfÃ¼hrer" },
            E: { icon: "ğŸ¦‹", name: "Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ", de: "Teamplayer" },
            A: { icon: "ğŸ¦‰", name: "ØªØ­Ù„ÛŒÙ„â€ŒÚ¯Ø±", de: "Analytiker" },
            C: { icon: "ğŸ¦š", name: "Ø®Ù„Ø§Ù‚", de: "Kreative" },
            I: { icon: "ğŸ¢", name: "Ù…ØªÙÚ©Ø±", de: "Denker" },
            S: { icon: "ğŸ¨", name: "Ø¢Ø±Ø§Ù…â€ŒØ·Ù„Ø¨", de: "Entspannte" }
        };

        // State
        let db = null;
        let gameCode = '';
        let isHost = false;
        let playerId = '';
        let playerName = '';
        let currentQuestion = 0;
        let gameRef = null;

        // Utility
        function generateCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        function toPersianNum(num) {
            const digits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
            return num.toString().split('').map(d => digits[parseInt(d)] || d).join('');
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // Initialize Firebase
        function initFirebase() {
            try {
                const config = {
                    apiKey: "AIzaSyBDChXlm34Kr7Gg0Dw458GiiwoLnWJAnxM",
                    authDomain: "lern-deutsch-arash.firebaseapp.com",
                    databaseURL: "https://lern-deutsch-arash-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "lern-deutsch-arash",
                    storageBucket: "lern-deutsch-arash.firebasestorage.app",
                    messagingSenderId: "845503292114",
                    appId: "1:845503292114:web:f76ab5fcde1e978d00c30b"
                };
                firebase.initializeApp(config);
                db = firebase.database();
                document.getElementById('loadingMsg').textContent = 'âœ… Ø¢Ù…Ø§Ø¯Ù‡!';
                setTimeout(() => {
                    document.getElementById('loadingMsg').style.display = 'none';
                }, 1000);
                return true;
            } catch (e) {
                console.error('Firebase error:', e);
                document.getElementById('loadingMsg').textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„';
                return false;
            }
        }

        // Host Functions
        function showHostSetup() {
            if (!db) {
                alert('Firebase nicht verbunden!');
                return;
            }
            isHost = true;
            gameCode = generateCode();
            gameRef = db.ref('surveys/' + gameCode);
            
            gameRef.set({
                status: 'lobby',
                currentQuestion: 0,
                players: {},
                responses: {},
                createdAt: Date.now()
            });

            document.getElementById('gameCodeDisplay').textContent = gameCode;
            showScreen('hostLobby');

            gameRef.child('players').on('value', (snap) => {
                const players = snap.val() || {};
                const names = Object.values(players);
                document.getElementById('playersCount').textContent = names.length;
                document.getElementById('playersList').innerHTML = names.map(n => 
                    `<span class="player-chip">${n}</span>`
                ).join('');
                document.getElementById('startGameBtn').disabled = names.length < 1;
            });
        }

        function startGame() {
            gameRef.update({ status: 'playing', currentQuestion: 0 });
            showQuestionHost(0);
        }

        function showQuestionHost(qIdx) {
            currentQuestion = qIdx;
            const q = questions[qIdx];
            
            document.getElementById('hostControls').style.display = 'flex';
            document.getElementById('questionProgress').textContent = 
                `Ø³Ø¤Ø§Ù„ ${toPersianNum(qIdx + 1)} Ø§Ø² ${toPersianNum(questions.length)}`;
            document.getElementById('questionText').textContent = q.question;
            
            document.getElementById('optionsGrid').innerHTML = q.options.map((opt, i) => `
                <div class="option-btn disabled">
                    <div class="option-icon">${opt.icon}</div>
                    <div class="option-text">${opt.text}</div>
                </div>
            `).join('');
            
            showScreen('questionScreen');

            gameRef.child('responses/' + qIdx).on('value', (snap) => {
                const resp = snap.val() || {};
                document.getElementById('responsesCount').textContent = 
                    `${toPersianNum(Object.keys(resp).length)} Ù¾Ø§Ø³Ø®`;
            });
        }

        function showQuestionStats() {
            const q = questions[currentQuestion];
            
            gameRef.child('responses/' + currentQuestion).once('value', (snap) => {
                const resp = snap.val() || {};
                const counts = [0, 0, 0, 0];
                Object.values(resp).forEach(r => counts[r]++);
                const total = Object.keys(resp).length || 1;

                document.getElementById('statsBars').innerHTML = q.options.map((opt, i) => {
                    const pct = Math.round(counts[i] / total * 100);
                    return `
                        <div class="stat-bar-item">
                            <div class="stat-bar-label">
                                <span>${opt.icon} ${opt.text}</span>
                                <span>${toPersianNum(counts[i])} Ù†ÙØ±</span>
                            </div>
                            <div class="stat-bar-container">
                                <div class="stat-bar color-${i}" style="width: ${pct}%">${pct}%</div>
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('statsNextBtn').textContent = 
                    currentQuestion < questions.length - 1 ? 'Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ÛŒ â†' : 'ğŸ† Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ';
                document.getElementById('statsOverlay').classList.add('show');
            });
        }

        function nextQuestion() {
            document.getElementById('statsOverlay').classList.remove('show');
            
            if (currentQuestion < questions.length - 1) {
                currentQuestion++;
                gameRef.update({ currentQuestion: currentQuestion });
                showQuestionHost(currentQuestion);
            } else {
                gameRef.update({ status: 'finished' });
                showFinalResults();
            }
        }

        function showFinalResults() {
            gameRef.child('responses').once('value', (snap) => {
                const allResp = snap.val() || {};
                const typeCounts = { L: 0, E: 0, A: 0, C: 0, I: 0, S: 0 };
                
                Object.keys(allResp).forEach(qIdx => {
                    Object.values(allResp[qIdx]).forEach(optIdx => {
                        const type = questions[qIdx].options[optIdx].type;
                        typeCounts[type]++;
                    });
                });

                const sorted = Object.entries(typeCounts).sort((a, b) => b[1] - a[1]);
                document.getElementById('personalityResults').innerHTML = sorted.map(([t, c]) => `
                    <div class="personality-card">
                        <div class="personality-icon">${personalities[t].icon}</div>
                        <div class="personality-name">${personalities[t].name} | ${personalities[t].de}</div>
                        <div class="personality-count">${toPersianNum(c)}</div>
                    </div>
                `).join('');

                document.getElementById('vocabRecap').innerHTML = questions.slice(0, 10).map(q => `
                    <div class="vocab-recap-item"><strong>${q.vocab.fa}</strong> = ${q.vocab.de}</div>
                `).join('');

                showScreen('resultsScreen');
            });
        }

        // Player Functions
        function showJoinScreen() {
            showScreen('joinScreen');
            document.getElementById('code1').focus();
        }

        function joinGame() {
            const code = ['code1','code2','code3','code4'].map(id => 
                document.getElementById(id).value.toUpperCase()
            ).join('');
            const name = document.getElementById('playerName').value.trim();
            
            if (code.length !== 4) {
                document.getElementById('joinError').textContent = 'Ú©Ø¯ Û´ Ø­Ø±ÙÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
                return;
            }
            if (!name) {
                document.getElementById('joinError').textContent = 'Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯';
                return;
            }

            gameCode = code;
            playerName = name;
            playerId = 'p_' + Date.now();
            gameRef = db.ref('surveys/' + gameCode);

            gameRef.once('value', (snap) => {
                if (!snap.exists()) {
                    document.getElementById('joinError').textContent = 'Ø¨Ø§Ø²ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!';
                    return;
                }

                gameRef.child('players/' + playerId).set(name);
                document.getElementById('playerNameDisplay').textContent = name;
                showScreen('playerWaiting');

                gameRef.on('value', (snap) => {
                    const game = snap.val();
                    if (!game) return;
                    if (game.status === 'playing') {
                        showQuestionPlayer(game.currentQuestion);
                    } else if (game.status === 'finished') {
                        showPlayerResults();
                    }
                });
            });
        }

        function showQuestionPlayer(qIdx) {
            currentQuestion = qIdx;
            const q = questions[qIdx];
            
            document.getElementById('hostControls').style.display = 'none';
            document.getElementById('questionProgress').textContent = 
                `Ø³Ø¤Ø§Ù„ ${toPersianNum(qIdx + 1)} Ø§Ø² ${toPersianNum(questions.length)}`;
            document.getElementById('questionText').textContent = q.question;
            
            gameRef.child('responses/' + qIdx + '/' + playerId).once('value', (snap) => {
                const answered = snap.exists();
                
                document.getElementById('optionsGrid').innerHTML = q.options.map((opt, i) => `
                    <div class="option-btn ${answered ? 'disabled' : ''}" data-idx="${i}">
                        <div class="option-icon">${opt.icon}</div>
                        <div class="option-text">${opt.text}</div>
                    </div>
                `).join('');

                if (!answered) {
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            selectOption(parseInt(this.dataset.idx));
                        });
                    });
                }
            });
            
            showScreen('questionScreen');
        }

        function selectOption(idx) {
            gameRef.child('responses/' + currentQuestion + '/' + playerId).set(idx);
            document.querySelectorAll('.option-btn').forEach((btn, i) => {
                btn.classList.add('disabled');
                if (i === idx) btn.classList.add('selected');
            });
        }

        function showPlayerResults() {
            gameRef.child('responses').once('value', (snap) => {
                const allResp = snap.val() || {};
                const typeCounts = { L: 0, E: 0, A: 0, C: 0, I: 0, S: 0 };
                
                Object.keys(allResp).forEach(qIdx => {
                    const myAns = allResp[qIdx][playerId];
                    if (myAns !== undefined) {
                        typeCounts[questions[qIdx].options[myAns].type]++;
                    }
                });

                const dominant = Object.entries(typeCounts).sort((a, b) => b[1] - a[1])[0][0];
                const p = personalities[dominant];

                document.getElementById('personalityResults').innerHTML = `
                    <div class="personality-card" style="grid-column: span 2;">
                        <div class="personality-icon" style="font-size: 4rem;">${p.icon}</div>
                        <div class="personality-name" style="font-size: 1.5rem;">Ø´Ù…Ø§: ${p.name} | ${p.de}</div>
                    </div>
                `;

                document.getElementById('vocabRecap').innerHTML = questions.slice(0, 10).map(q => `
                    <div class="vocab-recap-item"><strong>${q.vocab.fa}</strong> = ${q.vocab.de}</div>
                `).join('');

                showScreen('resultsScreen');
            });
        }

        // Code Input Navigation
        function setupCodeInputs() {
            const inputs = ['code1', 'code2', 'code3', 'code4'];
            inputs.forEach((id, i) => {
                const el = document.getElementById(id);
                el.addEventListener('input', function() {
                    this.value = this.value.toUpperCase();
                    if (this.value && i < 3) {
                        document.getElementById(inputs[i + 1]).focus();
                    }
                });
                el.addEventListener('keydown', function(e) {
                    if (e.key === 'Backspace' && !this.value && i > 0) {
                        document.getElementById(inputs[i - 1]).focus();
                    }
                });
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase
            initFirebase();
            
            // Setup code inputs
            setupCodeInputs();

            // Button handlers
            document.getElementById('hostBtn').addEventListener('click', showHostSetup);
            document.getElementById('playerBtn').addEventListener('click', showJoinScreen);
            document.getElementById('backToWelcome').addEventListener('click', () => showScreen('welcomeScreen'));
            document.getElementById('joinBtn').addEventListener('click', joinGame);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('showStatsBtn').addEventListener('click', showQuestionStats);
            document.getElementById('statsNextBtn').addEventListener('click', nextQuestion);
            document.getElementById('restartBtn').addEventListener('click', () => location.reload());
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (gameRef && playerId) {
                gameRef.child('players/' + playerId).remove();
            }
        });
    </script>
</body>
</html>
