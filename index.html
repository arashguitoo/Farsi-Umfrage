<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø²Ù†Ø¯Ù‡ | Live-Umfrage</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
    <script data-goatcounter="https://aguitoo.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Vazirmatn', Arial, sans-serif;
            background: #0f172a;
            min-height: 100vh;
            direction: rtl;
            color: #f1f5f9;
        }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        
        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .welcome-card {
            background: linear-gradient(135deg, #6366f1, #f472b6);
            border-radius: 24px;
            padding: 40px 30px;
            text-align: center;
            margin-top: 30px;
        }
        .welcome-icon { font-size: 4rem; margin-bottom: 20px; }
        .welcome-title { font-size: 2rem; font-weight: 700; margin-bottom: 10px; }
        .welcome-subtitle { font-size: 1rem; opacity: 0.9; margin-bottom: 30px; }
        
        .status-msg {
            background: rgba(0,0,0,0.2);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .status-msg.loading { color: #fbbf24; }
        .status-msg.ready { color: #10b981; }
        .status-msg.error { color: #ef4444; }
        
        .role-buttons { display: flex; flex-direction: column; gap: 15px; max-width: 300px; margin: 0 auto; }
        
        .role-btn {
            padding: 18px 30px;
            border: none;
            border-radius: 16px;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .role-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .role-btn.host { background: white; color: #6366f1; }
        .role-btn.player { background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.4); }
        .role-btn:not(:disabled):hover { transform: scale(1.05); }
        
        .card {
            background: #1e293b;
            border-radius: 24px;
            padding: 35px;
            margin-top: 25px;
            text-align: center;
        }
        .card h2 { color: #fbbf24; margin-bottom: 20px; font-size: 1.4rem; }
        
        .code-display {
            background: linear-gradient(135deg, #6366f1, #f472b6);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
        }
        .code-label { opacity: 0.9; margin-bottom: 10px; }
        .code-value { font-size: 3rem; font-weight: 700; letter-spacing: 12px; direction: ltr; }
        
        .code-inputs { display: flex; justify-content: center; gap: 10px; margin: 20px 0; direction: ltr; }
        .code-input {
            width: 55px; height: 65px;
            text-align: center;
            font-size: 1.8rem; font-weight: 700;
            border: 2px solid #334155;
            border-radius: 10px;
            background: #0f172a;
            color: white;
            text-transform: uppercase;
            font-family: inherit;
        }
        .code-input:focus { outline: none; border-color: #6366f1; }
        
        .text-input {
            width: 100%; max-width: 280px;
            padding: 15px;
            border: 2px solid #334155;
            border-radius: 12px;
            background: #0f172a;
            color: white;
            font-size: 1.1rem;
            text-align: center;
            font-family: inherit;
            margin: 15px 0;
        }
        .text-input:focus { outline: none; border-color: #6366f1; }
        
        .btn {
            padding: 15px 35px;
            border: none;
            border-radius: 25px;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn:not(:disabled):hover { transform: scale(1.03); }
        .btn-primary { background: linear-gradient(135deg, #6366f1, #f472b6); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-secondary { background: #334155; color: white; }
        
        .players-count { font-size: 3rem; font-weight: 700; color: #10b981; margin: 15px 0; }
        .players-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 15px 0; }
        .player-chip { background: #334155; padding: 8px 16px; border-radius: 20px; font-size: 0.95rem; }
        
        .waiting-icon { font-size: 4rem; margin-bottom: 20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .waiting-name { color: #fbbf24; font-size: 1.3rem; margin-top: 15px; }
        
        .error-msg { color: #ef4444; margin-top: 15px; font-size: 0.95rem; }
        .back-link { color: #94a3b8; cursor: pointer; margin-top: 20px; display: inline-block; }
        .back-link:hover { color: white; }
        
        .question-progress { color: #94a3b8; margin-bottom: 15px; }
        .question-text { font-size: 1.3rem; line-height: 1.9; margin-bottom: 25px; }
        
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .option-btn {
            background: #334155;
            border: 3px solid transparent;
            border-radius: 14px;
            padding: 18px 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        .option-btn:hover:not(.disabled) { border-color: #6366f1; transform: scale(1.02); }
        .option-btn.selected { border-color: #6366f1; background: rgba(99,102,241,0.3); }
        .option-btn.disabled { opacity: 0.7; cursor: default; }
        .option-icon { font-size: 1.8rem; margin-bottom: 8px; }
        .option-text { font-size: 0.95rem; line-height: 1.5; }
        
        .host-bar {
            background: #1e293b;
            border-radius: 12px;
            padding: 12px 18px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .host-badge { background: #fbbf24; color: #0f172a; padding: 4px 12px; border-radius: 15px; font-weight: 600; font-size: 0.85rem; }
        .response-count { color: #10b981; font-weight: 600; }
        
        .stats-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(15,23,42,0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }
        .stats-overlay.show { display: flex; }
        .stats-card { background: #1e293b; border-radius: 20px; padding: 30px; max-width: 500px; width: 100%; }
        .stats-title { color: #fbbf24; font-size: 1.2rem; margin-bottom: 20px; text-align: center; }
        .stat-item { margin-bottom: 15px; }
        .stat-label { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9rem; }
        .stat-bar-bg { background: #334155; border-radius: 8px; height: 30px; overflow: hidden; }
        .stat-bar {
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-weight: 600;
            font-size: 0.85rem;
            min-width: 35px;
            transition: width 0.8s ease;
        }
        .stat-bar.c0 { background: linear-gradient(90deg, #ef4444, #f87171); }
        .stat-bar.c1 { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .stat-bar.c2 { background: linear-gradient(90deg, #10b981, #34d399); }
        .stat-bar.c3 { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        
        .results-icon { font-size: 4rem; margin-bottom: 15px; }
        .results-title { font-size: 1.6rem; background: linear-gradient(135deg, #6366f1, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 5px; }
        .results-subtitle { color: #94a3b8; margin-bottom: 25px; }
        .personality-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .personality-item { background: #334155; border-radius: 14px; padding: 18px; }
        .personality-item .icon { font-size: 2rem; margin-bottom: 8px; }
        .personality-item .name { font-weight: 600; margin-bottom: 4px; }
        .personality-item .count { color: #fbbf24; font-size: 1.4rem; font-weight: 700; }
        
        .vocab-box { background: #334155; border-radius: 14px; padding: 18px; margin-top: 20px; }
        .vocab-title { color: #fbbf24; margin-bottom: 12px; }
        .vocab-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .vocab-item { background: #0f172a; padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; }
        
        @media (max-width: 500px) {
            .options-grid, .personality-grid, .vocab-grid { grid-template-columns: 1fr; }
            .code-value { font-size: 2.2rem; letter-spacing: 8px; }
            .code-input { width: 48px; height: 58px; font-size: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome -->
        <div id="welcomeScreen" class="screen active">
            <div class="welcome-card">
                <div class="welcome-icon">ğŸ“Š</div>
                <h1 class="welcome-title">Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø²Ù†Ø¯Ù‡</h1>
                <p class="welcome-subtitle">Live-Meinungsumfrage | Ø´Ø®ØµÛŒØª Ø´ØºÙ„ÛŒ</p>
                
                <div class="status-msg loading" id="statusMsg">â³ Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...</div>
                
                <div class="role-buttons">
                    <button class="role-btn host" id="hostBtn" disabled>ğŸ‘¨â€ğŸ« Ù…ÛŒØ²Ø¨Ø§Ù† | Moderator</button>
                    <button class="role-btn player" id="playerBtn" disabled>ğŸ® Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ | Teilnehmer</button>
                </div>
            </div>
        </div>

        <!-- Host Lobby -->
        <div id="hostLobby" class="screen">
            <div class="card">
                <div class="code-display">
                    <p class="code-label">Ú©Ø¯ Ø¨Ø§Ø²ÛŒ | Spielcode</p>
                    <p class="code-value" id="gameCode">----</p>
                </div>
                <h2>ğŸ‘¥ Ø´Ø±Ú©Øªâ€ŒÚ©Ù†Ù†Ø¯Ú¯Ø§Ù† | Teilnehmer</h2>
                <p class="players-count" id="playerCount">0</p>
                <div class="players-list" id="playerList"></div>
                <button class="btn btn-success" id="startBtn" disabled>ğŸš€ Ø´Ø±ÙˆØ¹ Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ</button>
                <br><span class="back-link" id="hostBack">â† Ø¨Ø§Ø²Ú¯Ø´Øª</span>
            </div>
        </div>

        <!-- Join -->
        <div id="joinScreen" class="screen">
            <div class="card">
                <h2>ğŸ® ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯ | Beitreten</h2>
                <p style="color: #94a3b8;">Ú©Ø¯ Ø¨Ø§Ø²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</p>
                
                <div class="code-inputs">
                    <input type="text" class="code-input" maxlength="1" id="c1">
                    <input type="text" class="code-input" maxlength="1" id="c2">
                    <input type="text" class="code-input" maxlength="1" id="c3">
                    <input type="text" class="code-input" maxlength="1" id="c4">
                </div>
                
                <input type="text" class="text-input" id="playerName" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§ / Ihr Name">
                
                <button class="btn btn-primary" id="joinBtn">ÙˆØ±ÙˆØ¯ | Beitreten</button>
                <p class="error-msg" id="joinError"></p>
                <span class="back-link" id="joinBack">â† Ø¨Ø§Ø²Ú¯Ø´Øª</span>
            </div>
        </div>

        <!-- Waiting -->
        <div id="waitingScreen" class="screen">
            <div class="card">
                <div class="waiting-icon">â³</div>
                <h2>Ù…Ù†ØªØ¸Ø± Ø´Ø±ÙˆØ¹...</h2>
                <p style="color: #94a3b8;">Warten auf Spielstart</p>
                <p class="waiting-name" id="waitingName"></p>
            </div>
        </div>

        <!-- Question -->
        <div id="questionScreen" class="screen">
            <div class="host-bar" id="hostBar" style="display:none;">
                <span class="host-badge">ğŸ‘¨â€ğŸ« Ù…ÛŒØ²Ø¨Ø§Ù†</span>
                <span class="response-count" id="responseCount">Û° Ù¾Ø§Ø³Ø®</span>
                <button class="btn btn-primary" id="showStatsBtn" style="padding:8px 16px; font-size:0.9rem;">ğŸ“Š Ù†ØªØ§ÛŒØ¬</button>
            </div>
            <div class="card">
                <p class="question-progress" id="qProgress">Ø³Ø¤Ø§Ù„ Û± Ø§Ø² Û²Û°</p>
                <p class="question-text" id="qText">Ø³Ø¤Ø§Ù„</p>
                <div class="options-grid" id="optionsGrid"></div>
            </div>
        </div>

        <!-- Stats Overlay -->
        <div class="stats-overlay" id="statsOverlay">
            <div class="stats-card">
                <h3 class="stats-title">ğŸ“Š Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ† Ø³Ø¤Ø§Ù„</h3>
                <div id="statsBars"></div>
                <button class="btn btn-primary" id="nextQBtn" style="margin-top:20px;">Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ÛŒ â†</button>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsScreen" class="screen">
            <div class="card">
                <div class="results-icon">ğŸ‰</div>
                <h2 class="results-title">Ù†ØªØ§ÛŒØ¬ Ù†Ù‡Ø§ÛŒÛŒ</h2>
                <p class="results-subtitle">Endergebnisse</p>
                <div class="personality-grid" id="personalityGrid"></div>
                <div class="vocab-box">
                    <p class="vocab-title">ğŸ“š ÙˆØ§Ú˜Ú¯Ø§Ù†</p>
                    <div class="vocab-grid" id="vocabGrid"></div>
                </div>
                <button class="btn btn-secondary" id="restartBtn" style="margin-top:20px;">ğŸ”„ Ø¨Ø§Ø²ÛŒ Ø¬Ø¯ÛŒØ¯</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
    (function() {
        // ===== DATA =====
        const questions = [
            { q: "ØµØ¨Ø­â€ŒÙ‡Ø§ Ú†Ú¯ÙˆÙ†Ù‡ Ø¨Ù‡ Ø³Ø± Ú©Ø§Ø± Ù…ÛŒâ€ŒØ±ÙˆÛŒØ¯ØŸ", opts: [
                { icon: "â˜€ï¸", text: "Ø¨Ø§ Ø§Ù†Ø±Ú˜ÛŒ!", type: "E" },
                { icon: "ğŸ˜´", text: "Ø¨Ù‡ Ø³Ø®ØªÛŒ Ø¨ÛŒØ¯Ø§Ø±", type: "I" },
                { icon: "ğŸ§", text: "Ø¨Ø§ Ù…ÙˆØ³ÛŒÙ‚ÛŒ", type: "C" },
                { icon: "ğŸƒ", text: "Ø¹Ø¬Ù„Ù‡â€ŒØ§ÛŒ!", type: "S" }
            ], vocab: { fa: "ØµØ¨Ø­", de: "Morgen" }},
            { q: "Ø¯Ø± Ø¬Ù„Ø³Ø§Øª Ú©Ø§Ø±ÛŒ Ú†Ù‡ Ù†Ù‚Ø´ÛŒ Ø¯Ø§Ø±ÛŒØ¯ØŸ", opts: [
                { icon: "ğŸ¤", text: "Ø±Ù‡Ø¨Ø± Ø¨Ø­Ø«", type: "L" },
                { icon: "ğŸ‘‚", text: "Ø´Ù†ÙˆÙ†Ø¯Ù‡", type: "I" },
                { icon: "ğŸ“", text: "ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ†ÙˆÛŒØ³", type: "A" },
                { icon: "ğŸ’¡", text: "Ø§ÛŒØ¯Ù‡â€ŒÙ¾Ø±Ø¯Ø§Ø²", type: "C" }
            ], vocab: { fa: "Ø¬Ù„Ø³Ù‡", de: "Meeting" }},
            { q: "ÙˆÙ‚ØªÛŒ Ù‡Ù…Ú©Ø§Ø±ØªØ§Ù† Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±Ø¯ØŸ", opts: [
                { icon: "ğŸ¤", text: "ÙÙˆØ±Ø§Ù‹ Ú©Ù…Ú©", type: "E" },
                { icon: "ğŸ¤”", text: "Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§Ù‡Ø¯", type: "I" },
                { icon: "ğŸ“", text: "Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒÚ¯ÙˆÛŒÙ…", type: "A" },
                { icon: "ğŸ’ª", text: "Ø®ÙˆØ¯Ø´ Ø­Ù„ Ú©Ù†Ø¯", type: "L" }
            ], vocab: { fa: "Ù‡Ù…Ú©Ø§Ø±", de: "Kollege" }},
            { q: "Ù…Ø­ÛŒØ· Ú©Ø§Ø± Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ Ø´Ù…Ø§ØŸ", opts: [
                { icon: "ğŸ¢", text: "Ø¯ÙØªØ± Ø´Ù„ÙˆØº", type: "E" },
                { icon: "ğŸ ", text: "Ø®Ø§Ù†Ù‡", type: "I" },
                { icon: "â˜•", text: "Ú©Ø§ÙÙ‡", type: "C" },
                { icon: "ğŸŒ³", text: "Ø·Ø¨ÛŒØ¹Øª", type: "S" }
            ], vocab: { fa: "Ù…Ø­ÛŒØ· Ú©Ø§Ø±", de: "Arbeitsumfeld" }},
            { q: "Ú†Ú¯ÙˆÙ†Ù‡ ØªØµÙ…ÛŒÙ… Ù…ÛŒâ€ŒÚ¯ÛŒØ±ÛŒØ¯ØŸ", opts: [
                { icon: "ğŸ§ ", text: "Ù…Ù†Ø·Ù‚", type: "A" },
                { icon: "â¤ï¸", text: "Ø§Ø­Ø³Ø§Ø³", type: "C" },
                { icon: "ğŸ‘¥", text: "Ù…Ø´ÙˆØ±Øª", type: "E" },
                { icon: "âš¡", text: "Ø³Ø±ÛŒØ¹!", type: "S" }
            ], vocab: { fa: "ØªØµÙ…ÛŒÙ…", de: "Entscheidung" }},
            { q: "Ù¾Ø§Ø¯Ø§Ø´ Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ØŸ", opts: [
                { icon: "ğŸ’°", text: "Ù¾ÙˆÙ„", type: "A" },
                { icon: "ğŸ†", text: "ØªÙ‚Ø¯ÛŒØ±", type: "L" },
                { icon: "ğŸ‰", text: "Ù…Ø±Ø®ØµÛŒ", type: "S" },
                { icon: "ğŸ“ˆ", text: "Ø§Ø±ØªÙ‚Ø§", type: "L" }
            ], vocab: { fa: "Ù¾Ø§Ø¯Ø§Ø´", de: "Belohnung" }},
            { q: "ÙˆÙ‚ØªÛŒ Ú©Ø§Ø± Ø²ÛŒØ§Ø¯ Ø§Ø³ØªØŸ", opts: [
                { icon: "ğŸ“‹", text: "Ù„ÛŒØ³Øª Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ù…", type: "A" },
                { icon: "ğŸ˜°", text: "Ø§Ø³ØªØ±Ø³", type: "S" },
                { icon: "â˜•", text: "Ø§ÙˆÙ„ Ø§Ø³ØªØ±Ø§Ø­Øª", type: "I" },
                { icon: "ğŸ¦¸", text: "Ù‡Ù…Ù‡ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù…!", type: "E" }
            ], vocab: { fa: "Ø§Ø³ØªØ±Ø³", de: "Stress" }},
            { q: "Ø±Ø§Ø¨Ø·Ù‡ Ø¨Ø§ Ø±Ø¦ÛŒØ³ØŸ", opts: [
                { icon: "ğŸ˜Š", text: "ØµÙ…ÛŒÙ…ÛŒ", type: "E" },
                { icon: "ğŸ“", text: "Ø±Ø³Ù…ÛŒ", type: "A" },
                { icon: "ğŸ˜¬", text: "ØªØ±Ø³Ù†Ø§Ú©!", type: "I" },
                { icon: "ğŸ¤·", text: "Ù…Ù† Ø±Ø¦ÛŒØ³Ù…!", type: "L" }
            ], vocab: { fa: "Ø±Ø¦ÛŒØ³", de: "Chef" }},
            { q: "Ø§Ø³ØªØ±Ø§Ø­Øª Ù†Ø§Ù‡Ø§Ø±ØŸ", opts: [
                { icon: "ğŸ‘¥", text: "Ø¨Ø§ Ù‡Ù…Ú©Ø§Ø±Ø§Ù†", type: "E" },
                { icon: "ğŸ“±", text: "ØªÙ†Ù‡Ø§", type: "I" },
                { icon: "ğŸš¶", text: "Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ", type: "S" },
                { icon: "ğŸ’»", text: "Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù…!", type: "A" }
            ], vocab: { fa: "Ø§Ø³ØªØ±Ø§Ø­Øª", de: "Pause" }},
            { q: "Ø§Ú¯Ø± Ø§Ø´ØªØ¨Ø§Ù‡ Ú©Ù†ÛŒØ¯ØŸ", opts: [
                { icon: "ğŸ™‹", text: "Ø§Ø¹ØªØ±Ø§Ù", type: "E" },
                { icon: "ğŸ”§", text: "Ø¢Ø±Ø§Ù… Ø­Ù„", type: "I" },
                { icon: "ğŸ“Š", text: "ØªØ­Ù„ÛŒÙ„ Ú†Ø±Ø§", type: "A" },
                { icon: "ğŸ˜…", text: "Ú©Ø³ÛŒ Ù†ÙÙ‡Ù…Ø¯!", type: "S" }
            ], vocab: { fa: "Ø§Ø´ØªØ¨Ø§Ù‡", de: "Fehler" }},
            { q: "Ú†Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡â€ŒØ§ÛŒØŸ", opts: [
                { icon: "ğŸ¨", text: "Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡", type: "C" },
                { icon: "ğŸ“Š", text: "ØªØ­Ù„ÛŒÙ„ÛŒ", type: "A" },
                { icon: "ğŸ‘¥", text: "ØªÛŒÙ…ÛŒ", type: "E" },
                { icon: "ğŸƒ", text: "Ø³Ø±ÛŒØ¹", type: "S" }
            ], vocab: { fa: "Ù¾Ø±ÙˆÚ˜Ù‡", de: "Projekt" }},
            { q: "Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ Ø§ÛŒØ¯Ù‡â€ŒØ¢Ù„ØŸ", opts: [
                { icon: "ğŸŒ…", text: "ØµØ¨Ø­ Ø²ÙˆØ¯", type: "A" },
                { icon: "ğŸŒ™", text: "Ø´Ø¨", type: "C" },
                { icon: "ğŸ•", text: "Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±", type: "I" },
                { icon: "â°", text: "Û¹ ØªØ§ Ûµ", type: "S" }
            ], vocab: { fa: "Ø³Ø§Ø¹Øª", de: "Arbeitszeit" }},
            { q: "Ø§ÛŒØ¯Ù‡â€ŒÛŒ Ø¬Ø¯ÛŒØ¯ Ø¯Ø§Ø±ÛŒØ¯ØŸ", opts: [
                { icon: "ğŸ“¢", text: "Ø¨Ù‡ Ù‡Ù…Ù‡ Ù…ÛŒâ€ŒÚ¯ÙˆÛŒÙ…", type: "E" },
                { icon: "ğŸ“", text: "Ù…ÛŒâ€ŒÙ†ÙˆÛŒØ³Ù…", type: "I" },
                { icon: "ğŸš€", text: "Ø§Ø¬Ø±Ø§!", type: "L" },
                { icon: "ğŸ¤", text: "Ù…Ø´ÙˆØ±Øª", type: "C" }
            ], vocab: { fa: "Ø§ÛŒØ¯Ù‡", de: "Idee" }},
            { q: "Ú†Ù‡ Ú†ÛŒØ² Ù†Ø§Ø±Ø§Ø­ØªØŸ", opts: [
                { icon: "ğŸŒ", text: "Ú©Ø§Ø± Ú©Ù†Ø¯", type: "L" },
                { icon: "ğŸ˜¤", text: "Ø¨ÛŒâ€ŒØ§Ø­ØªØ±Ø§Ù…ÛŒ", type: "E" },
                { icon: "ğŸ“‹", text: "Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¨Ø¯", type: "C" },
                { icon: "â°", text: "Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø§Ø±ÛŒ", type: "S" }
            ], vocab: { fa: "Ù†Ø§Ø±Ø§Ø­Øª", de: "verÃ¤rgert" }},
            { q: "Ûµ Ø³Ø§Ù„ Ø¢ÛŒÙ†Ø¯Ù‡ØŸ", opts: [
                { icon: "ğŸ‘”", text: "Ù…Ø¯ÛŒØ±", type: "L" },
                { icon: "ğŸŒ´", text: "Ø¨Ø§Ø²Ù†Ø´Ø³ØªÙ‡!", type: "S" },
                { icon: "ğŸ“", text: "ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ", type: "C" },
                { icon: "ğŸ’¼", text: "Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ Ø¨Ù‡ØªØ±", type: "A" }
            ], vocab: { fa: "Ø¢ÛŒÙ†Ø¯Ù‡", de: "Zukunft" }},
            { q: "Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø§Ù†ØªÙ‚Ø§Ø¯ØŸ", opts: [
                { icon: "ğŸ™", text: "ØªØ´Ú©Ø±", type: "A" },
                { icon: "ğŸ˜¢", text: "Ù†Ø§Ø±Ø§Ø­Øª", type: "I" },
                { icon: "ğŸ¤¨", text: "Ø¨Ø³ØªÚ¯ÛŒ Ø¯Ø§Ø±Ø¯", type: "E" },
                { icon: "ğŸ’ª", text: "Ø§Ù†Ú¯ÛŒØ²Ù‡!", type: "L" }
            ], vocab: { fa: "Ø§Ù†ØªÙ‚Ø§Ø¯", de: "Kritik" }},
            { q: "ØºØ°Ø§ Ø¯Ø± Ú©Ø§Ø±ØŸ", opts: [
                { icon: "ğŸ¥—", text: "Ø³Ø§Ù„Ø§Ø¯", type: "A" },
                { icon: "ğŸ•", text: "Ù¾ÛŒØªØ²Ø§ ØªÛŒÙ…ÛŒ", type: "E" },
                { icon: "â˜•", text: "ÙÙ‚Ø· Ù‚Ù‡ÙˆÙ‡", type: "C" },
                { icon: "ğŸ±", text: "Ø®Ø§Ù†Ú¯ÛŒ", type: "I" }
            ], vocab: { fa: "ØºØ°Ø§", de: "Essen" }},
            { q: "Ù„Ø§ØªØ§Ø±ÛŒ Ø¨Ø¨Ø±ÛŒØ¯ØŸ", opts: [
                { icon: "ğŸƒ", text: "Ø§Ø³ØªØ¹ÙØ§!", type: "S" },
                { icon: "ğŸ’¼", text: "Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø§Ø±", type: "A" },
                { icon: "ğŸ¢", text: "Ø´Ø±Ú©Øª Ø®ÙˆØ¯Ù…", type: "L" },
                { icon: "ğŸŒ", text: "Ø³ÙØ±", type: "C" }
            ], vocab: { fa: "Ù„Ø§ØªØ§Ø±ÛŒ", de: "Lotterie" }},
            { q: "Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ù‡Ù†Ú¯Ø§Ù… Ú©Ø§Ø±ØŸ", opts: [
                { icon: "ğŸµ", text: "Ø´Ø§Ø¯", type: "E" },
                { icon: "ğŸ»", text: "Ú©Ù„Ø§Ø³ÛŒÚ©", type: "I" },
                { icon: "ğŸ”‡", text: "Ø³Ú©ÙˆØª", type: "A" },
                { icon: "ğŸ¸", text: "Ø§Ù†Ø±Ú˜ÛŒâ€ŒØ¨Ø®Ø´", type: "C" }
            ], vocab: { fa: "Ù…ÙˆØ³ÛŒÙ‚ÛŒ", de: "Musik" }},
            { q: "Ø¬Ù…Ù„Ù‡ Ù…ÙˆØ±Ø¯ Ø¹Ù„Ø§Ù‚Ù‡ØŸ", opts: [
                { icon: "ğŸŒŸ", text: "ØªÙ„Ø§Ø´=Ù…ÙˆÙÙ‚ÛŒØª", type: "L" },
                { icon: "ğŸ˜Œ", text: "Ø¢Ø±Ø§Ù…Ø´ Ù…Ù‡Ù…", type: "S" },
                { icon: "ğŸ¤", text: "Ø¨Ø§ Ù‡Ù… Ù‚ÙˆÛŒ", type: "E" },
                { icon: "ğŸ§ ", text: "Ø¯Ø§Ù†Ø´=Ù‚Ø¯Ø±Øª", type: "A" }
            ], vocab: { fa: "Ù…ÙˆÙÙ‚", de: "erfolgreich" }}
        ];

        const personalities = {
            L: { icon: "ğŸ¦", fa: "Ø±Ù‡Ø¨Ø±", de: "AnfÃ¼hrer" },
            E: { icon: "ğŸ¦‹", fa: "Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ", de: "Teamplayer" },
            A: { icon: "ğŸ¦‰", fa: "ØªØ­Ù„ÛŒÙ„â€ŒÚ¯Ø±", de: "Analytiker" },
            C: { icon: "ğŸ¦š", fa: "Ø®Ù„Ø§Ù‚", de: "Kreative" },
            I: { icon: "ğŸ¢", fa: "Ù…ØªÙÚ©Ø±", de: "Denker" },
            S: { icon: "ğŸ¨", fa: "Ø¢Ø±Ø§Ù…â€ŒØ·Ù„Ø¨", de: "Entspannte" }
        };

        // ===== STATE =====
        let db = null;
        let gameRef = null;
        let gameCode = '';
        let isHost = false;
        let playerId = '';
        let currentQ = 0;

        // ===== HELPERS =====
        function $(id) { return document.getElementById(id); }
        function show(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            $(id).classList.add('active');
        }
        function makeCode() {
            const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
            return Array(4).fill(0).map(() => c[Math.floor(Math.random()*c.length)]).join('');
        }
        function toFa(n) {
            return n.toString().split('').map(d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d] || d).join('');
        }

        // ===== FIREBASE INIT =====
        function initFirebase() {
            if (typeof firebase === 'undefined') {
                $('statusMsg').className = 'status-msg error';
                $('statusMsg').textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ';
                return false;
            }
            try {
                firebase.initializeApp({
                    apiKey: "AIzaSyBDChXlm34Kr7Gg0Dw458GiiwoLnWJAnxM",
                    authDomain: "lern-deutsch-arash.firebaseapp.com",
                    databaseURL: "https://lern-deutsch-arash-default-rtdb.europe-west1.firebasedatabase.app",
                    projectId: "lern-deutsch-arash"
                });
                db = firebase.database();
                $('statusMsg').className = 'status-msg ready';
                $('statusMsg').textContent = 'âœ… Ø¢Ù…Ø§Ø¯Ù‡!';
                $('hostBtn').disabled = false;
                $('playerBtn').disabled = false;
                return true;
            } catch(e) {
                $('statusMsg').className = 'status-msg error';
                $('statusMsg').textContent = 'âŒ ' + e.message;
                return false;
            }
        }

        // ===== HOST =====
        function hostGame() {
            isHost = true;
            gameCode = makeCode();
            gameRef = db.ref('surveys/' + gameCode);
            gameRef.set({ status: 'lobby', currentQ: 0, players: {}, responses: {}, ts: Date.now() });
            $('gameCode').textContent = gameCode;
            show('hostLobby');
            
            gameRef.child('players').on('value', snap => {
                const p = snap.val() || {};
                const names = Object.values(p);
                $('playerCount').textContent = names.length;
                $('playerList').innerHTML = names.map(n => `<span class="player-chip">${n}</span>`).join('');
                $('startBtn').disabled = names.length < 1;
            });
        }

        function startGame() {
            gameRef.update({ status: 'playing', currentQ: 0 });
            showQ(0);
        }

        function showQ(idx) {
            currentQ = idx;
            const q = questions[idx];
            $('hostBar').style.display = isHost ? 'flex' : 'none';
            $('qProgress').textContent = `Ø³Ø¤Ø§Ù„ ${toFa(idx+1)} Ø§Ø² ${toFa(questions.length)}`;
            $('qText').textContent = q.q;
            
            $('optionsGrid').innerHTML = q.opts.map((o, i) => `
                <div class="option-btn ${isHost ? 'disabled' : ''}" data-i="${i}">
                    <div class="option-icon">${o.icon}</div>
                    <div class="option-text">${o.text}</div>
                </div>
            `).join('');
            
            if (!isHost) {
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.onclick = function() { selectOpt(parseInt(this.dataset.i)); };
                });
            }
            
            show('questionScreen');
            
            if (isHost) {
                gameRef.child('responses/' + idx).on('value', snap => {
                    const r = snap.val() || {};
                    $('responseCount').textContent = toFa(Object.keys(r).length) + ' Ù¾Ø§Ø³Ø®';
                });
            }
        }

        function selectOpt(i) {
            if (!playerId) return;
            gameRef.child('responses/' + currentQ + '/' + playerId).set(i);
            document.querySelectorAll('.option-btn').forEach((btn, idx) => {
                btn.classList.add('disabled');
                btn.onclick = null;
                if (idx === i) btn.classList.add('selected');
            });
        }

        function showStats() {
            const q = questions[currentQ];
            gameRef.child('responses/' + currentQ).once('value', snap => {
                const r = snap.val() || {};
                const counts = [0,0,0,0];
                Object.values(r).forEach(v => counts[v]++);
                const total = Object.keys(r).length || 1;
                
                $('statsBars').innerHTML = q.opts.map((o, i) => {
                    const pct = Math.round(counts[i]/total*100);
                    return `
                        <div class="stat-item">
                            <div class="stat-label">
                                <span>${o.icon} ${o.text}</span>
                                <span>${toFa(counts[i])} Ù†ÙØ±</span>
                            </div>
                            <div class="stat-bar-bg">
                                <div class="stat-bar c${i}" style="width:${pct}%">${pct}%</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                $('nextQBtn').textContent = currentQ < questions.length-1 ? 'Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯ÛŒ â†' : 'ğŸ† Ù†ØªØ§ÛŒØ¬';
                $('statsOverlay').classList.add('show');
            });
        }

        function nextQ() {
            $('statsOverlay').classList.remove('show');
            if (currentQ < questions.length-1) {
                currentQ++;
                gameRef.update({ currentQ });
                showQ(currentQ);
            } else {
                gameRef.update({ status: 'finished' });
                showResults();
            }
        }

        function showResults() {
            gameRef.child('responses').once('value', snap => {
                const all = snap.val() || {};
                const types = { L:0, E:0, A:0, C:0, I:0, S:0 };
                
                Object.keys(all).forEach(qIdx => {
                    Object.values(all[qIdx]).forEach(optIdx => {
                        types[questions[qIdx].opts[optIdx].type]++;
                    });
                });
                
                const sorted = Object.entries(types).sort((a,b) => b[1]-a[1]);
                $('personalityGrid').innerHTML = sorted.map(([t, c]) => `
                    <div class="personality-item">
                        <div class="icon">${personalities[t].icon}</div>
                        <div class="name">${personalities[t].fa} | ${personalities[t].de}</div>
                        <div class="count">${toFa(c)}</div>
                    </div>
                `).join('');
                
                $('vocabGrid').innerHTML = questions.slice(0,10).map(q => 
                    `<div class="vocab-item"><b>${q.vocab.fa}</b> = ${q.vocab.de}</div>`
                ).join('');
                
                show('resultsScreen');
            });
        }

        // ===== PLAYER =====
        function joinScreen() {
            show('joinScreen');
            $('c1').focus();
        }

        function joinGame() {
            const code = ['c1','c2','c3','c4'].map(id => $(id).value.toUpperCase()).join('');
            const name = $('playerName').value.trim();
            
            if (code.length !== 4) { $('joinError').textContent = 'Ú©Ø¯ Û´ Ø­Ø±ÙÛŒ'; return; }
            if (!name) { $('joinError').textContent = 'Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'; return; }
            
            gameCode = code;
            playerId = 'p' + Date.now();
            gameRef = db.ref('surveys/' + gameCode);
            
            gameRef.once('value', snap => {
                if (!snap.exists()) { $('joinError').textContent = 'Ø¨Ø§Ø²ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!'; return; }
                
                gameRef.child('players/' + playerId).set(name);
                $('waitingName').textContent = name;
                show('waitingScreen');
                
                gameRef.on('value', snap => {
                    const g = snap.val();
                    if (!g) return;
                    if (g.status === 'playing') showQ(g.currentQ);
                    if (g.status === 'finished') showPlayerResult();
                });
            });
        }

        function showPlayerResult() {
            gameRef.child('responses').once('value', snap => {
                const all = snap.val() || {};
                const types = { L:0, E:0, A:0, C:0, I:0, S:0 };
                
                Object.keys(all).forEach(qIdx => {
                    const my = all[qIdx][playerId];
                    if (my !== undefined) types[questions[qIdx].opts[my].type]++;
                });
                
                const best = Object.entries(types).sort((a,b) => b[1]-a[1])[0][0];
                const p = personalities[best];
                
                $('personalityGrid').innerHTML = `
                    <div class="personality-item" style="grid-column: span 2;">
                        <div class="icon" style="font-size:3rem;">${p.icon}</div>
                        <div class="name" style="font-size:1.3rem;">Ø´Ù…Ø§: ${p.fa} | ${p.de}</div>
                    </div>
                `;
                
                $('vocabGrid').innerHTML = questions.slice(0,10).map(q => 
                    `<div class="vocab-item"><b>${q.vocab.fa}</b> = ${q.vocab.de}</div>`
                ).join('');
                
                show('resultsScreen');
            });
        }

        // ===== CODE INPUTS =====
        ['c1','c2','c3','c4'].forEach((id, i) => {
            $(id).oninput = function() {
                this.value = this.value.toUpperCase();
                if (this.value && i < 3) $(['c1','c2','c3','c4'][i+1]).focus();
            };
            $(id).onkeydown = function(e) {
                if (e.key === 'Backspace' && !this.value && i > 0) $(['c1','c2','c3','c4'][i-1]).focus();
            };
        });

        // ===== EVENTS =====
        $('hostBtn').onclick = hostGame;
        $('playerBtn').onclick = joinScreen;
        $('hostBack').onclick = () => show('welcomeScreen');
        $('joinBack').onclick = () => show('welcomeScreen');
        $('startBtn').onclick = startGame;
        $('joinBtn').onclick = joinGame;
        $('showStatsBtn').onclick = showStats;
        $('nextQBtn').onclick = nextQ;
        $('restartBtn').onclick = () => location.reload();

        // ===== CLEANUP =====
        window.onbeforeunload = () => {
            if (gameRef && playerId) gameRef.child('players/' + playerId).remove();
        };

        // ===== INIT - Wait for Firebase =====
        function waitForFirebase() {
            if (typeof firebase !== 'undefined') {
                initFirebase();
            } else {
                setTimeout(waitForFirebase, 100);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForFirebase);
        } else {
            waitForFirebase();
        }
    })();
    </script>
</body>
</html>
